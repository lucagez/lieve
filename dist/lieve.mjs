import{METHODS as t}from"http";var e=function(t){return t.replace(/\//g,"")};function r(t){return function(e){if("function"!=typeof e)throw new TypeError("Middleware must be of type function");this[t]=this[t].concat([e])}}var i={queryDelimiter:"?",notFound:{message:"Not Found",type:"text/plain"}};export default function(n){var s=this;if(void 0===n&&(n={}),n&&"object"!=typeof n)throw new TypeError("Config must be of type object");this.routes=new Map,this.asRegistered=[],this.middlewares=[],this.errMiddlewares=[],this.lookup=null,this.find=null,function(t){var e=this;Object.keys(i).forEach(function(r){e[r]=t[r]||i[r]})}.bind(this)(n),t.forEach(function(t){s[t]=function(t){return function(r,i,n){var s;if("string"!=typeof r)throw new TypeError("Endpoint must be a string");if("function"!=typeof n)throw new TypeError("Handler must be a function");if(!Array.isArray(i))throw new TypeError("Middlewares must be an array");if(i.length>0&&i.filter(function(t){return"function"!=typeof t}).length>0)throw new TypeError("Every middleware should be a function");var o=e(r);this.asRegistered.push(r);var a=this.routes.get(o)||{};this.routes.set(o,Object.assign({},a,((s={})[t]=i.concat([n]),s)))}}(t).bind(s)}),this.redirect=function(t,r){var i=new Map,n=r.routes,s=r.asRegistered,o=r.middlewares,a=r.errMiddlewares,u=e(t);n.forEach(function(t,e){return i.set(""+u+e,t)}),this.routes=new Map(Array.from(this.routes).concat(Array.from(i))),this.asRegistered=this.asRegistered.concat(s.map(function(t){return""+u+t})),this.middlewares=this.middlewares.concat(o),this.errMiddlewares=this.errMiddlewares.concat(a)}.bind(this),this.use=r("middlewares").bind(this),this.err=r("errMiddlewares").bind(this),this.start=function(){var t,e,r,i=this;return this.lookup=this.asRegistered.map(function(t){return t.split("/")}).flat().concat([""]).reduce(function(t,e){var r;return Object.assign({},t,((r={})[e]=0,r))},{}),this.find=(t=this.lookup,e=this.queryDelimiter,r=new RegExp("\\"+e+"(.*)"),function(i){var n,s="",o=[],a=i.split("/");if(i.indexOf(e)>-1){var u=a.length-1;a[u]=a[u].replace(r,function(t){return n=t.substr(1),""})}for(var f=a.length,c=0;c<f;c++){var d=a[c];void 0!==t[d]?s+=d:(o.push(d),s+=":par")}return{path:s,params:o,query:n}}),this.routes.forEach(function(t,e){var r={};Object.keys(t).forEach(function(e){r[e]=i.middlewares.concat(t[e])}),i.routes.set(e,r)}),function(t,e){var r=t.method,n=i.find(t.url),s=n.params,o=n.query,a=(i.routes.get(n.path)||{})[r];if("object"!=typeof a)return function(t,e){var r=e.message;t.writeHead(404,{"Content-Type":e.type}),t.end(r)}(e,i.notFound);t.params=s,t.query=o,function(t,e,r,i){var n=t,s=0;return function t(o){var a=[r,i,t];void 0!==o&&(n=e,s=0,a=[o,r,i,t]);var u=n[s++];if(u)return u.apply(void 0,a)}}(a,i.errMiddlewares,t,e)()}}.bind(this)}
