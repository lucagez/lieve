{"version":3,"file":"lieve.mjs","sources":["../src/utils.mjs","../src/queues.js","../src/lieve.mjs","../src/find.js","../src/router.js"],"sourcesContent":["function _body(req, type) {\n  return new Promise((resolve) => {\n    const chunks = [];\n    req.on('data', chunk => chunks.push(chunk));\n    req.on('end', () => {\n      const body = Buffer.concat(chunks).toString();\n      switch (type) {\n        case 'x-www-form-urlencoded':\n          const parsed = {};\n          body.split('&').forEach((e) => {\n            const [prop, value] = e.split('=');\n            parsed[prop] = value;\n          });\n          resolve(parsed);\n          break;\n        case 'binary':\n          resolve({ file: body });\n          break;\n        default:\n          resolve(body);\n      }\n    });\n  });\n}\n\nfunction _cookie(req) {\n  const { cookie } = req.headers;\n  if (!cookie) return {};\n  const basket = {};\n  cookie.split(';').forEach((e) => {\n    const [prop, value] = e.split('=').map(f => f.trim());\n    basket[prop] = value;\n  });\n  return basket;\n}\n\nfunction _query(req, delimiter = '&') {\n  const { url } = req;\n  const query = {};\n  url.match(/[^?]+$/)[0].split(delimiter).forEach((e) => {\n    const [prop, value] = e.split('=');\n    query[prop] = value;\n  });\n  return query;\n}\n\nfunction _list(routes) {\n  const pieces = Object.keys(routes)\n    .map(e => e.split('/').slice(1))\n    .flat()\n    .filter(e => e !== ':par');\n\n  // `.join()` => if using regex test in routes\n  return Array.from(new Set(pieces));\n}\n\nfunction _set(req, prop, value, writable = false) {\n  Object.defineProperty(req, prop, {\n    value,\n    writable,\n  });\n}\n\nfunction _send(content, type = 'text/plain', status = 200) {\n  // use this for `turbo-http`\n  // this.statusCode = status;\n  // this.setHeader('Content-Type', type);\n\n  // use this for core `http`\n  this.writeHead(status, { 'Content-Type': type });\n  this.end(content, false, false);\n}\n\nfunction _next(req, res) {\n  this.index += 1;\n  return this.queue[this.index](req, res);\n}\n\nfunction _dummy(err) {\n  if (err) throw new Error(err);\n  return 0;\n}\n\nfunction _express(req, res, middleware, args = []) {\n  const { next } = req;\n  middleware(...args)(req, res, _dummy);\n  next(req, res);\n}\n\nexport {\n  _body,\n  _cookie,\n  _query,\n  _send,\n  _set,\n  _next,\n  _list,\n  _express,\n};\n","const toArr = obj => Object.keys(obj).map(e => obj[e]);\n\nfunction _single(obj) {\n  const queues = {};\n  Object.keys(obj).forEach((endpoint) => {\n    if (endpoint !== 'use' && endpoint !== 'extend') {\n      const { extend } = obj;\n      const usedEndpoint = extend ? extend + endpoint.replace(/\\/$/, '') : endpoint;\n\n      queues[usedEndpoint] = {};\n\n      const route = obj[endpoint];\n      Object.keys(route).forEach((method) => {\n        if (method !== 'use') {\n          const useAll = obj.use || {};\n          const afterAll = obj.after || {};\n          const useRoute = route.use || {};\n          const afterRoute = route.after || {};\n          const arrUseAll = toArr(useAll);\n          const arrAfterAll = toArr(afterAll);\n          const arrUseRoute = toArr(useRoute);\n          const arrAfterRoute = toArr(afterRoute);\n\n          const current = route[method];\n          const handlerQueue = typeof current === 'function'\n            ? current\n            : (() => {\n              const { handler } = current;\n              const useHandler = current.use || {};\n              const afterHandler = current.after || {};\n\n              const arrUseHandler = toArr(useHandler);\n              const arrAfterHandler = toArr(afterHandler);\n              return [...arrUseHandler, ...handler, ...arrAfterHandler];\n            })();\n\n          const queue = [\n            ...arrUseAll,\n            ...arrUseRoute,\n            handlerQueue,\n            ...arrAfterRoute,\n            ...arrAfterAll,\n          ].flat();\n          queues[usedEndpoint][method] = queue;\n        }\n      });\n    }\n  });\n\n  return queues;\n}\n\nexport default function _queues(routes) {\n  const extended = {};\n  const filtered = {};\n  Object.keys(routes).forEach((route) => {\n    if (routes[route].hasOwnProperty('extend')) {\n      extended[route] = routes[route];\n    } else {\n      filtered[route] = routes[route];\n    }\n  });\n\n  let merged = {};\n  Object.keys(extended).forEach((ext) => {\n    merged = {\n      ...merged,\n      ..._single(extended[ext]),\n    };\n  });\n\n  return {\n    ...merged,\n    ..._single(filtered),\n  };\n}\n","import router from './router';\nimport _queues from './queues';\nimport _find from './find';\nimport { _list } from './utils';\n\nexport class Lieve {\n  constructor(routes) {\n    this.routes = routes;\n    this.queues = _queues(routes);\n    this.list = _list(routes);\n\n    this.matchUrl = new RegExp(/\\/$|\\?(.*)/);\n\n    // Updated regex => avoid matching eg: `v1` as param.\n    // Matches only numeric params. Both: `/xxx/` and `/xxx`\n    this.matchParams = new RegExp(/(?<=\\/)\\d+/g);\n    // this.matchParams = new RegExp(/[0-9]+[^\\/]?/g);\n\n    this.find = _find.bind(this);\n    this.router = router.bind(this);\n  }\n}\n\nexport {\n  _body,\n  _cookie,\n  _query,\n  _set,\n  _express,\n} from './utils';\n","export default function _find(url) {\n  const params = [];\n  if (url === '/') {\n    return {\n      path: url,\n      params,\n    };\n  }\n\n  const use = url.replace(this.matchUrl, '');\n  const path = use.replace(this.matchParams, (param) => {\n    params.push(param);\n    return ':par';\n  });\n\n  return { path, params };\n}\n","import { _send, _next } from './utils';\n\nexport default function router(req, res) {\n  const { url, method } = req;\n  const { path, params } = this.find(url);\n\n  res.send = _send;\n\n  const endpoint = this.queues[path];\n  if ((endpoint || {}).hasOwnProperty(method)) {\n    const queue = endpoint[method];\n    req.params = params;\n    req.queue = queue;\n    req.index = 0;\n    req.next = _next.bind(req);\n\n    queue[0](req, res);\n  } else {\n    res.send(JSON.stringify({\n      error: 'Not Found',\n      status: 404,\n    }), 'application/json', 404);\n  }\n}\n"],"names":["_body","req","type","Promise","resolve","chunks","on","chunk","push","body","Buffer","concat","toString","parsed","split","forEach","e","file","_cookie","headers","cookie","basket","map","f","trim","_query","delimiter","url","query","match","_set","prop","value","writable","Object","defineProperty","_send","content","status","writeHead","end","_dummy","err","Error","_express","res","middleware","args","next","const","toArr","obj","keys","_single","queues","endpoint","extend","usedEndpoint","replace","route","method","afterAll","after","useRoute","use","afterRoute","arrUseAll","arrAfterAll","arrUseRoute","arrAfterRoute","current","handlerQueue","afterHandler","arrUseHandler","arrAfterHandler","handler","queue","flat","Lieve","constructor","routes","extended","filtered","hasOwnProperty","merged","ext","_queues","list","pieces","slice","filter","Array","from","Set","_list","matchUrl","RegExp","matchParams","find","params","path","this","param","bind","router","send","index","JSON","stringify","error"],"mappings":"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"}