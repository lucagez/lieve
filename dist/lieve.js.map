{"version":3,"file":"lieve.js","sources":["../src/utils.mjs","../src/queues.js","../src/lieve.mjs","../src/find.js","../src/router.js"],"sourcesContent":["const _body = (req, type) => {\n  return new Promise(resolve => {\n    const chunks = [];\n    req.on('data', chunk => chunks.push(chunk))\n    req.on('end', () => {\n      const body = Buffer.concat(chunks).toString();\n      switch (type) {\n        case 'x-www-form-urlencoded':\n          const parsed = {};\n          body.split('&').map(e => {\n            const [prop, value] = e.split('=');\n            parsed[prop] = value;\n          });\n          resolve(parsed);\n          break;\n        case 'binary':\n          resolve({ file: body });\n          break;\n        default:\n          resolve(body);\n      }\n    });\n  });\n};\n\nconst _cookie = req => {\n  const { cookie } = req.headers;\n  if (!cookie) return {};\n  const basket = {};\n  cookie.split(';').forEach(e => {\n    const [prop, value] = e.split('=').map(e => e.trim());\n    basket[prop] = value;\n  });\n  return basket;\n};\n\nconst _query = (req, delimiter = '&') => {\n  const { url } = req;\n  const query = {};\n  url.match(/[^?]+$/)[0].split(delimiter).map(e => {\n    const [prop, value] = e.split('=');\n    query[prop] = value;\n  });\n  return query;\n};\n\nconst _list = (routes) => {\n  const pieces = Object.keys(routes)\n    .map(e => e.split('/').slice(1))\n    .flat()\n    .filter(e => e !== ':par');\n\n  return Array.from(new Set(pieces))//.join();\n};\n\nconst _set = (req, prop, value, writable = false) => {\n  Object.defineProperty(req, prop, {\n    value,\n    writable,\n  });\n};\n\nfunction _send(content, type = 'text/plain', status = 200) {\n  // use this for `turbo-http`\n  // this.statusCode = status;\n  // this.setHeader('Content-Type', type);\n\n  // use this for core `http`\n  this.writeHead(status, { 'Content-Type': type });\n  \n  this.end(content, false, false);\n};\n\nfunction _next(req, res) {\n  this.index += 1;\n  return this.queue[this.index](req, res);\n};\n\nfunction _dummy(err) {\n  if (err) throw new Error(err);\n  return;\n};\n\nfunction _express(req, res, middleware, args = []) {\n  const { next } = req;\n  middleware(...args)(req, res, _dummy);\n  next(req, res);\n};\n\nexport {\n  _body,\n  _cookie,\n  _query,\n  _send,\n  _set,\n  _next,\n  _list,\n  _express,\n};\n\n","const toArr = obj => Object.keys(obj).map(e => obj[e]);\n\nconst _single = obj => {\n  const queues = {};\n  Object.keys(obj).forEach(endpoint => {\n    if (endpoint !== 'use' && endpoint !== 'extend') {\n      const { extend } = obj;\n      const usedEndpoint = extend ? extend + endpoint.replace(/\\/$/, '') : endpoint;\n\n      queues[usedEndpoint] = {};\n\n      const route = obj[endpoint];\n      Object.keys(route).forEach(method => {\n        if (method !== 'use') {\n          const useAll = obj.use || {};\n          const afterAll = obj.after || {};\n          const useRoute = route.use || {};\n          const afterRoute = route.after || {};\n          const arrUseAll = toArr(useAll);\n          const arrAfterAll = toArr(afterAll);\n          const arrUseRoute = toArr(useRoute);\n          const arrAfterRoute = toArr(afterRoute);\n\n          const current = route[method];\n          const handler = typeof current === 'function'\n            ? current\n            : (() => {\n              const { handler } = current;\n              const useHandler = current.use || {};\n              const afterHandler = current.after || {};\n\n              const arrUseHandler = toArr(useHandler);\n              const arrAfterHandler = toArr(afterHandler);\n              return [...arrUseHandler, ...handler, ...arrAfterHandler];\n            })();\n\n          const queue = [...arrUseAll, ...arrUseRoute, handler, ...arrAfterRoute, ...arrAfterAll].flat();\n          queues[usedEndpoint][method] = queue;\n        }\n      });\n    }\n  });\n\n  return queues;\n}\n\nexport default function _queues(routes) {\n  const extended = {};\n  const filtered = {};\n  Object.keys(routes).forEach(e => {\n    if (routes[e].hasOwnProperty('extend')) {\n      extended[e] = routes[e];\n    } else {\n      filtered[e] = routes[e];\n    }\n  });\n\n  let merged = {};\n  Object.keys(extended).forEach(e => {\n    merged = {\n      ...merged,\n      ..._single(extended[e]),\n    };\n  });\n\n  return {\n    ...merged,\n    ..._single(filtered),\n  };\n};\n\n","import router from './router';\nimport _queues from './queues';\nimport _find from './find';\nimport { _list } from './utils';\n\nexport class Lieve {\n  constructor(routes) {\n    this.routes = routes;\n    this.queues = _queues(routes);\n    this.list = _list(routes);\n\n    console.log(this.queues);\n    this.matchUrl = new RegExp(/\\/$|\\?(.*)/);\n\n    // Updated regex => avoid matching eg: `v1` as param.\n    // Matches only numeric params. Both: `/xxx/` and `/xxx`\n    this.matchParams = new RegExp(/(?<=\\/)\\d+/g);\n    // this.matchParams = new RegExp(/[0-9]+[^\\/]?/g);\n\n    this.find = _find.bind(this);\n    this.router = router.bind(this);\n  };\n};\n\nexport { _body, _cookie, _query, _set, _express } from './utils';\n\n","export default function _find(url) {\n  const params = [];\n  if (url === '/') return {\n    path: url,\n    params,\n  };\n\n  const use = url.replace(this.matchUrl, '');\n  const path = use.replace(this.matchParams, param => {\n    params.push(param);\n    return ':par';\n  });\n\n  return { path, params };\n};\n\n","import { _send, _next, _list } from './utils';\n\nexport default function router(req, res) {\n  const { url, method } = req;\n  const { path, params } = this.find(url);\n\n  res['send'] = _send;\n  \n  const endpoint = this.queues[path];\n  if ((endpoint || {}).hasOwnProperty(method)) {\n    const queue = endpoint[method];\n    req['params'] = params;\n    req['queue'] = queue;\n    req['index'] = 0;\n    req['next'] = _next.bind(req);\n    \n    queue[0](req, res);\n  } else {\n    res.send(JSON.stringify({\n      error: 'Not Found',\n      status: 404,\n    }), 'application/json', 404);\n  };\n};\n\n"],"names":["_send","content","type","status","writeHead","end","_dummy","err","Error","const","toArr","obj","Object","keys","map","e","_single","queues","forEach","endpoint","extend","usedEndpoint","replace","route","method","afterAll","after","useRoute","use","afterRoute","arrUseAll","arrAfterAll","arrUseRoute","arrAfterRoute","current","handler","afterHandler","arrUseHandler","arrAfterHandler","queue","flat","constructor","routes","extended","filtered","hasOwnProperty","merged","_queues","list","pieces","split","slice","filter","Array","from","Set","_list","log","this","matchUrl","RegExp","matchParams","find","url","params","path","param","push","bind","router","req","res","index","send","JSON","stringify","error","Promise","resolve","chunks","on","chunk","body","Buffer","concat","toString","parsed","file","headers","cookie","basket","trim","delimiter","query","match","prop","value","writable","defineProperty","middleware","args","next"],"mappings":"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"}